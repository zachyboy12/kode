<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kode Editor</title>
  <style>
    .toprightbar {
      float: right;
    }
    .topleftbar {
      float: left;
    }
    .terminal {
      width: 100%;
      height: 100vh;
      resize: none;
      border-left: 10% rgb(200, 198, 198);
      border-right: none;
      border-bottom: none;
      border-top: 10% rgb(200, 198, 198);
      outline: none;
    }
    .runbutton {
      float: left;
    }
    button {
      align-items: center;
      background-color: #fff;
      border: 2px solid #000;
      box-sizing: border-box;
      color: #000;
      cursor: pointer;
      display: inline-flex;
      fill: #000;
      font-size: 16px;
      font-weight: 600;
      height: 48px;
      justify-content: center;
      letter-spacing: -.8px;
      line-height: 24px;
      min-width: 130px;
      outline: 0;
      padding: 0 17px;
      text-align: center;
      text-decoration: none;
      transition: all .3s;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    button:focus {
      color: #171e29;
    }

    button:hover {
      border-color: #06f;
      color: #06f;
      fill: #06f;
    }

    button:active {
      border-color: #06f;
      color: #06f;
      fill: #06f;
    }

    @media (min-width: 768px) {
      button {
        min-width: 170px;
      }
    }
    input {
      min-width: 170px;
      min-height: 40px;
      font-size: 20px;
    }
    * {
      font-family: 'Courier New';
    }
    .session {
      align-items: center;
      display: inline-flex;
    }
  </style>
</head>
<body>
  <div id="topleftbar" class="topleftbar">
    <input id="filename" class="filename" placeholder="File Name" spellcheck="false">
    <button id="savebutton" class="savebutton" onclick="save()">Save</button>
    <button id="uploadbutton" class="uploadbutton" onclick="upload()">Upload</button>
    <pre id="session" class="session"></pre>
    <br>
  </div>
  <div id="toprightbar" class="toprightbar">
    <button id="runbutton" class="runbutton" onclick="run()">Run</button>
  </div>
  <br>
  <br>
  <br>
  <br>
  <div id="code" class="code"></div>
  <textarea id="terminal" class="terminal" onkeydown="checkInput()" spellcheck="false">kode@Editor-System /kode/sessions % </textarea>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.14.0/ace.js" integrity="sha512-WYlXqL7GPpZL2ImDErTX0RMKy5hR17vGW5yY04p9Z+YhYFJcUUFRT31N29euNB4sLNNf/s0XQXZfzg3uKSoOdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.14.0/ext-language_tools.js"></script>
  <script type="text/javascript">
    async function run () {
      const code = editor.getValue();
      const pyodide = await loadPyodide({
        stdout: (text) => {terminal.value += text + '\n';},
        stderr: (text) => {terminal.value += text + '\n';}
      });
      pyodide.runPython('import sys, js; sys.platform = js.navigator.platform');
      try { 
        let result = pyodide.runPython(code);
        terminal.value += result + '\nkode@Editor-System /kode/sessions % ';
      } catch (error) {
        terminal.value += error + '\nkode@Editor-System /kode/sessions % ';
      }
    }
    function runCommand () {
      previousCommands.push(command);
      if (command === undefined) {
        terminal.value += '\n'
        return;
      }
      if (command === 'clear' || command === 'cls') {
        terminal.value = '';
      }
      else if (command.startsWith('python') || command.startsWith('python3')) {
        terminal.value += '\n';
        run();
      }
      else if (command.startsWith('echo')) {
        terminal.value += '\n' + command.slice(5) + '\n'
      }
      else if (command === '') {
        terminal.value += '\n'
      }
      else {
        terminal.value += '\nkodeterm: command not found: ' + command + '\n';
      }
    }
    function commandMenuItemExecute (commandItem) {
      if (commandItem.startsWith('get previous command ')) {
        let result = previousCommands[Number(commandItem.slice(21))];
        terminal.value += result;
        command = result;
      }
    }
    function parseAlias (aliasString) {
      
    }
    function commandMenu () {
      menuItem = prompt('Command:')
      if (!menuItem) {
        return;
      }
      commandMenuItemExecute(menuItem.toLowerCase());
    }
    function checkInput () {
      let event = window.event || event.which;
      console.log(event);
      if (['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', 'z', 'x', 'c', 'v', 'b', 'n', 'm', '`', '~', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '=', '+', ' ', '[', '{', ']', '}', '\\', '|', ';', ':', '"', "'", '<', '>', ',', '.', '/', '?'].includes(event.key.toLowerCase())) {
        command += event.key;
        return;
      }
      if (event.key === 'Backspace' && command) {
        command = command.slice(0, -1);
        return;
      }
      else if (event.key === 'Backspace' && !command) {
        event.preventDefault();
        return;
      }
      if (event.keyCode === 13) {
        event.preventDefault();
        runCommand();
      }
      else if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
        event.preventDefault();
        return;
      }
      else if (event.key === 'ArrowUp') {
        event.preventDefault();
        commandMenu();
        return;
      }
      else if (event.key === 'ArrowDown') {
        event.preventDefault();
        return;
      }
      else {
        return;
      }
      command = "";
      terminal.value += 'kode@Editor-System /kode/sessions % '
    }
    function save () {
      let blob = new Blob([editor.getValue()]);
      let url = window.URL.createObjectURL(blob);
      let filename = document.getElementById("filename").value;
      if (!filename) {
        filename = "file.py";
      }
      downloadURI(url, filename);
      window.URL.revokeObjectURL(url);
    }
    function downloadURI(uri, name) {
      let link = document.createElement("a");
      link.download = name;
      link.href = uri;
      link.click();
    }
    
    function readInputFile (inputElement, callback) {
      const reader = new FileReader();
      reader.onload = () => {
        callback(reader.result)
      };
      reader.readAsText(inputElement.files[0]);
    };

    function upload () {
      var element = document.createElement('input');
      element.setAttribute('type', 'file');
      element.style.display = 'none';
      document.body.appendChild(element);
      element.onchange = () => {
        readInputFile(element, (data) => {
          editor.setValue(data);
          document.body.removeChild(element);
        }
      )}
      element.click();
    }

    const editor = ace.edit("code");
    const urlSearchParams = new URLSearchParams(window.location.search);
    const queryParameters = Object.fromEntries(urlSearchParams.entries());
    if (queryParameters.session && localStorage.getItem(queryParameters.session)) {
      editor.setValue(localStorage.getItem(queryParameters.session));
      document.getElementById("session").innerHTML = queryParameters.session;
    }
    let command = "";
    let previousCommands = [];
    let commandNumber = previousCommands.length;
    editor.setTheme("ace/theme/tomorrow");
    editor.getSession().setMode("ace/mode/python");
    console.log('Ace Options: ', Object.keys(editor.$options))
    editor.setOptions({
      enableAutoIndent: true,
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: true,
      animatedScroll: true,
      fontFamily: 'Courier New',
      fontSize: 17,
    });
    document.getElementById("code").style.height = "600px";
    const terminal = document.getElementById("terminal")
    terminal.addEventListener('mousedown', (event) => {
      event.preventDefault();
      terminal.focus();
      terminal.setSelectionRange(terminal.value.length, terminal.value.length);
    })
    window.addEventListener('beforeunload', (event) => {
      if (queryParameters.session) {
        localStorage.setItem(queryParameters.session, editor.getValue());
      }
    })
    </script>
</body>
</html>
